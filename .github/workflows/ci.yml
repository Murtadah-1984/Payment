name: CI - Build, Test & Quality

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  DOTNET_VERSION: '8.0.x'
  SOLUTION_FILE: Payment.sln
  BUILD_CONFIGURATION: Release

jobs:
  # Code Quality & Formatting
  code-quality:
    name: Code Quality & Formatting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Install dotnet-format
        run: dotnet tool install -g dotnet-format

      - name: Check code formatting
        run: dotnet format --verify-no-changes --verbosity diagnostic

      - name: Run analyzers
        run: dotnet build ${{ env.SOLUTION_FILE }} --configuration ${{ env.BUILD_CONFIGURATION }} --no-restore

  # Security Scanning
  security-scan:
    name: Security & Vulnerability Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore dependencies
        run: dotnet restore ${{ env.SOLUTION_FILE }} --verbosity minimal

      - name: Check for vulnerable packages
        run: |
          dotnet list ${{ env.SOLUTION_FILE }} package --vulnerable --include-transitive || true

      - name: Run OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'Payment-API'
          path: '.'
          format: 'HTML'
          args: >
            --scan src/
            --out reports/
            --enableRetired
            --enableExperimental
        continue-on-error: true

      - name: Upload dependency check report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependency-check-report
          path: reports/
          retention-days: 30

  # Build Solution
  build:
    name: Build Solution
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore dependencies
        run: dotnet restore ${{ env.SOLUTION_FILE }} --verbosity minimal

      - name: Build solution
        run: dotnet build ${{ env.SOLUTION_FILE }} --configuration ${{ env.BUILD_CONFIGURATION }} --no-restore

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: '**/bin/${{ env.BUILD_CONFIGURATION }}/**/*.dll'
          retention-days: 1

  # Unit Tests with Coverage
  test:
    name: Unit Tests & Coverage
    runs-on: ubuntu-latest
    needs: build
    strategy:
      matrix:
        test-project:
          - tests/Payment.Domain.Tests/Payment.Domain.Tests.csproj
          - tests/Payment.Application.Tests/Payment.Application.Tests.csproj
          - tests/Payment.Infrastructure.Tests/Payment.Infrastructure.Tests.csproj
          - tests/Payment.API.Tests/Payment.API.Tests.csproj

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore dependencies
        run: dotnet restore ${{ env.SOLUTION_FILE }} --verbosity minimal

      - name: Run tests with coverage
        run: |
          dotnet test ${{ matrix.test-project }} \
            --configuration ${{ env.BUILD_CONFIGURATION }} \
            --no-build \
            --verbosity normal \
            --collect:"XPlat Code Coverage" \
            --results-directory:"${{ runner.temp }}/TestResults"

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.test-project }}
          path: ${{ runner.temp }}/TestResults/**/*
          retention-days: 7

  # Code Coverage Report
  coverage:
    name: Code Coverage Report
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          path: ${{ runner.temp }}/TestResults

      - name: Generate coverage report
        uses: danielpalme/ReportGenerator-GitHub-Action@5.2.0
        with:
          reports: '${{ runner.temp }}/TestResults/**/coverage.cobertura.xml'
          targetdir: '${{ runner.temp }}/coverage'
          reporttypes: 'HtmlInline_AzurePipelines;Cobertura;Badges'

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: '${{ runner.temp }}/TestResults/**/coverage.cobertura.xml'
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: ${{ runner.temp }}/coverage
          retention-days: 30

  # Docker Build Test
  docker-build-test:
    name: Docker Build Test
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: false
          tags: payment-api:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # All Checks Summary
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [code-quality, security-scan, build, test, coverage, docker-build-test]
    if: always()
    steps:
      - name: CI Status
        run: |
          echo "## CI Pipeline Status âœ…" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Code Quality | ${{ needs.code-quality.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Coverage | ${{ needs.coverage.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker Build | ${{ needs.docker-build-test.result }} |" >> $GITHUB_STEP_SUMMARY

